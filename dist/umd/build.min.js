!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports,require("vscode-languageserver-types"),require("escodegen"),require("esprima")):"function"==typeof define&&define.amd?define(["exports","vscode-languageserver-types","escodegen","esprima"],factory):factory((global=global||self)["charts-language-service"]={},global.vscodeLanguageserverTypes,global.escodegen,global.esprima)}(this,function(exports,vscodeLanguageserverTypes,escodegen,esprima){"use strict";var extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};function __generator(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}}function __values(o){var m="function"==typeof Symbol&&o[Symbol.iterator],i=0;return m?m.call(o):{next:function(){return o&&i>=o.length&&(o=void 0),{value:o&&o[i++],done:!o}}}}function __read(o,n){var m="function"==typeof Symbol&&o[Symbol.iterator];if(!m)return o;var r,e,i=m.call(o),ar=[];try{for(;(void 0===n||n-- >0)&&!(r=i.next()).done;)ar.push(r.value)}catch(error){e={error:error}}finally{try{r&&!r.done&&(m=i.return)&&m.call(i)}finally{if(e)throw e.error}}return ar}function __spread(){for(var ar=[],i=0;i<arguments.length;i++)ar=ar.concat(__read(arguments[i]));return ar}var INTERVAL_UNITS=["nanosecond","millisecond","second","minute","hour","day","week","month","quarter","year"],CALENDAR_KEYWORDS=["current_day","current_hour","current_minute","current_month","current_quarter","current_week","current_year","first_day","first_vacation_day","first_working_day","friday","last_vacation_day","last_working_day","monday","next_day","next_hour","next_minute","next_month","next_quarter","next_vacation_day","next_week","next_working_day","next_year","now","previous_day","previous_hour","previous_minute","previous_month","previous_quarter","previous_vacation_day","previous_week","previous_working_day","previous_year","saturday","sunday","thursday","tuesday","wednesday"],CONTROL_KEYWORDS=["sql","script","if","for","var","list","csv"],DefaultSetting=function(){function DefaultSetting(setting){if(this.description="",this.displayName="",this.enum=[],this.example="",this.excludes=[],this.maxValue=1/0,this.minValue=-1/0,this.multiLine=!1,this.name="",this.type="",this.widget=[],this.overrideCache=[],Object.assign(this,setting),this.enum=this.enum.map(function(v){return v.toLowerCase()}),this.name=DefaultSetting.clearSetting(this.displayName),this.override)for(var scope in this.override)this.override.hasOwnProperty(scope)&&this.overrideCache.push({setting:this.override[scope],test:this.getOverrideTest(scope)})}return DefaultSetting.prototype.applyScope=function(scope){if(null==this.override)return this;var matchingOverrides=this.overrideCache.filter(function(override){return override.test(scope)}).map(function(override){return override.setting});return matchingOverrides.length>0?Object.assign.apply(Object,__spread([this],matchingOverrides)):this},DefaultSetting.prototype.toString=function(){if(null==this.description)return"";var result=this.description+"  \n\n";null!=this.example&&""!==this.example&&(result+="Example: "+this.displayName+" = "+this.example+"  \n"),null!=this.type&&""!==this.type&&(result+="Type: "+this.type+"  \n"),null!=this.defaultValue&&""!==this.defaultValue&&(result+="Default value: "+this.defaultValue+"  \n"),null==this.enum&&0===this.enum.length&&(result+="Possible values: "+this.enum.join()+"  \n"),null!=this.excludes&&0!==this.excludes.length&&(result+="Can not be specified with: "+this.excludes.join()+"  \n"),null!=this.maxValue&&this.maxValue!==1/0&&(result+="Maximum: "+this.maxValue+"  \n"),null!=this.minValue&&this.minValue!==-1/0&&(result+="Minimum: "+this.minValue+"  \n"),null!=this.section&&0!==this.section.length&&(result+="Allowed in section: "+this.section+"  \n");var widgets="all";return"string"!=typeof this.widget&&this.widget.length>0?widgets=this.widget.join(", "):this.widget.length>0&&(widgets=this.widget),result+="Allowed in widgets: "+widgets+"  \n"},DefaultSetting.prototype.getOverrideTest=function(scopeSrc){var scopeKeys=["widget","section"],scopeSrcExtracted=/^\[(.*)\]$/.exec(scopeSrc);if(null==scopeSrcExtracted)throw new Error("Wrong override scope format");var source="return !!("+scopeSrcExtracted[1]+");",compiledScope=new Function(scopeKeys.join(),source);return function(scope){try{var values=scopeKeys.map(function(key){return scope[key]});return compiledScope.apply(void 0,values)}catch(error){console.error("In '"+scopeSrc+"' :: "+error)}}},DefaultSetting.clearSetting=function(str){return str.toLowerCase().replace(/[^a-z]/g,"")},DefaultSetting.clearValue=function(str){return str.toLowerCase()},DefaultSetting}(),unknownToken=function(found){return found+" is unknown."},uselessScope=function(found,msg){return found+" setting is appplied only if "+msg+"."},illegalSetting=function(found){return found+" setting is not allowed here."},CSV_FROM_URL_MISSING_NAME_PATTERN=/(^[ \t]*csv[ \t]+)[ \t]*(from)/,noMatching=function(dependent,required){return dependent+" has no matching "+required},lineFeedRequired=function(dependent){return"A linefeed character after '"+dependent+"' keyword is required"},Util=function(){function Util(){}return Util.isInMap=function(value,map){var e_1,_a,e_2,_b;if(null==value)return!1;try{for(var _c=__values(map.values()),_d=_c.next();!_d.done;_d=_c.next()){var array=_d.value;try{for(var array_1=(e_2=void 0,__values(array)),array_1_1=array_1.next();!array_1_1.done;array_1_1=array_1.next()){var item=array_1_1.value;if(Array.isArray(item)&&item.includes(value)||item===value)return!0}}catch(e_2_1){e_2={error:e_2_1}}finally{try{array_1_1&&!array_1_1.done&&(_b=array_1.return)&&_b.call(array_1)}finally{if(e_2)throw e_2.error}}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_1)throw e_1.error}}return!1},Util.isAnyInArray=function(target,array){var e_3,_a;try{for(var target_1=__values(target),target_1_1=target_1.next();!target_1_1.done;target_1_1=target_1.next()){var item=target_1_1.value;if(array.includes(item))return!0}}catch(e_3_1){e_3={error:e_3_1}}finally{try{target_1_1&&!target_1_1.done&&(_a=target_1.return)&&_a.call(target_1)}finally{if(e_3)throw e_3.error}}return!1},Util.countCsvColumns=function(line){return 0===line.length?0:line.replace(/(['"]).+\1/g,"").split(",").length},Util.createDiagnostic=function(range,message,severity){return void 0===severity&&(severity=vscodeLanguageserverTypes.DiagnosticSeverity.Error),vscodeLanguageserverTypes.Diagnostic.create(range,message,severity,void 0,"Axibase Charts")},Util.deleteComments=function(text){var content=text,multiLine=/\/\*[\s\S]*?\*\//g,oneLine=/^[ \t]*#.*/gm,match=multiLine.exec(content);for(null===match&&(match=oneLine.exec(content));null!==match;){var newLines=match[0].split("\n").length-1,spaces=Array(match[0].length).fill(" ").concat(Array(newLines).fill("\n")).join("");content=""+content.substr(0,match.index)+spaces+content.substr(match.index+match[0].length),null===(match=multiLine.exec(content))&&(match=oneLine.exec(content))}return content},Util.deleteScripts=function(text){return text.replace(/\bscript\b([\s\S]+?)\bendscript\b/g,"script\nendscript")},Util.repetitionDiagnostic=function(range,declaredAbove,current){var message,diagnosticSeverity=["script","thresholds","colors"].includes(current.name)?vscodeLanguageserverTypes.DiagnosticSeverity.Warning:vscodeLanguageserverTypes.DiagnosticSeverity.Error;switch(current.name){case"script":message="Multi-line scripts are deprecated.\nGroup multiple scripts into blocks:\nscript\nendscript";break;case"thresholds":message="Replace multiple `thresholds` settings with one, for example:\nthresholds = 0\nthresholds = 60\nthresholds = 80\n\nthresholds = 0, 60, 80",declaredAbove.values.push(current.value);break;case"colors":message="Replace multiple `colors` settings with one, for example:\ncolors = red\ncolors = yellow\ncolors = green\n\ncolors = red, yellow, green",declaredAbove.values.push(current.value);break;default:message=declaredAbove.displayName+" is already defined"}return Util.createDiagnostic(range,message,diagnosticSeverity)},Util.isEmpty=function(str){return/^\s*$/.test(str)},Util.createRange=function(start,length,lineNumber){return vscodeLanguageserverTypes.Range.create(vscodeLanguageserverTypes.Position.create(lineNumber,start),vscodeLanguageserverTypes.Position.create(lineNumber,start+length))},Util}(),intervalUnits=["nanosecond","millisecond","second","minute","hour","day","week","month","quarter","year"],booleanRegExp=new RegExp("^(?:"+["false","no","null","none","0","off","true","yes","on","1"].join("|")+")$"),calendarRegExp=new RegExp("^(?:"+["current_day","current_hour","current_minute","current_month","current_quarter","current_week","current_year","first_day","first_vacation_day","first_working_day","friday","last_vacation_day","last_working_day","monday","next_day","next_hour","next_minute","next_month","next_quarter","next_vacation_day","next_week","next_working_day","next_year","now","previous_day","previous_hour","previous_minute","previous_month","previous_quarter","previous_vacation_day","previous_week","previous_working_day","previous_year","saturday","sunday","thursday","tuesday","wednesday"].join("|")+")(?:[ \\t]*[-+][ \\t]*(?:\\d+|(?:\\d+)?\\.\\d+)[ \\t]*\\*[ \\t]*(?:"+intervalUnits.join("|")+"))?$"),integerRegExp=/^[-+]?\d+$/,intervalRegExp=new RegExp("^(?:(?:[-+]?(?:(?:\\d+|(?:\\d+)?\\.\\d+)|@\\{.+\\})[ \\t]*(?:"+intervalUnits.join("|")+"))|all)$"),localDateRegExp=new RegExp("^(?:19[7-9]|[2-9]\\d\\d)\\d(?:-(?:0[1-9]|1[0-2])(?:-(?:0[1-9]|[12][0-9]|3[01])(?: (?:[01]\\d|2[0-4]):(?:[0-5][0-9])(?::(?:[0-5][0-9]))?(?:\\.\\d{1,9})?)?)?)?$"),numberRegExp=/^(?:\-|\+)?(?:\.\d+|\d+(?:\.\d+)?)$/,zonedDateRegExp=new RegExp("^(?:19[7-9]|[2-9]\\d\\d)\\d-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12][0-9]|3[01])[tT](?:[01]\\d|2[0-4]):(?:[0-5][0-9]):(?:[0-5][0-9])(?:\\.\\d{1,9})?(?:[zZ]|[+-](?:[01]\\d|2[0-4]):?(?:[0-5][0-9]))$"),calculatedRegExp=/[@$]\{.+\}/;var CheckPriority,specificValueChecksMap=new Map([["forecastssagroupmanualgroups",{errMsg:"Incorrect group syntax",isIncorrect:function(value){return!/^[\d\s,;-]+$/.test(value)}}],["forecastssagroupautounion",{errMsg:"Incorrect group union syntax",isIncorrect:function(value){return!/^[a-z\s,;-]+$/.test(value)}}]]),Setting=function(_super){function Setting(setting){var _this=_super.call(this,setting)||this;return _this.value="",_this.values=[],_this}return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}(Setting,_super),Object.defineProperty(Setting.prototype,"textRange",{get:function(){return this._textRange},set:function(value){this._textRange=value},enumerable:!0,configurable:!0}),Setting.prototype.checkType=function(range){var result,text,_this=this;if(calculatedRegExp.test(this.value))return result;switch(this.type){case"string":if(!/\S/.test(this.value)){result=Util.createDiagnostic(range,this.displayName+" can not be empty");break}if(this.enum.length>0){if(this.value.split(/\s*,\s*/).some(function(s){return _this.enum.indexOf(s)<0})){var enumList=this.enum.sort().join("\n * ");result=Util.createDiagnostic(range,this.displayName+" must contain only the following:\n * "+enumList)}break}var specCheck=specificValueChecksMap.get(this.name);specCheck&&specCheck.isIncorrect(this.value)&&(result=Util.createDiagnostic(range,specCheck.errMsg));break;case"number":var persent=/(\d*)%/.exec(this.value);"arrowlength"===this.name&&persent&&(this.maxValue="object"==typeof this.maxValue?100*this.maxValue.value:100*this.maxValue,this.minValue="object"==typeof this.minValue?100*this.minValue.value:100*this.minValue,this.value=persent[1]),result=this.checkNumber(numberRegExp,this.displayName+" should be a real (floating-point) number.",range);break;case"integer":result=this.checkNumber(integerRegExp,this.displayName+" should be an integer number.",range);break;case"boolean":booleanRegExp.test(this.value)||(result=Util.createDiagnostic(range,this.displayName+" should be a boolean value. For example, "+this.example));break;case"enum":var index=this.findIndexInEnum(this.value);if(0===this.enum.length)result=Util.createDiagnostic(range,illegalSetting(this.displayName));else if(index<0){if(/percentile/.test(this.value)&&/statistic/.test(this.name)){result=this.checkPercentile(range);break}enumList=this.enum.sort().join("\n * ").replace(/percentile\\.+/,"percentile(n)");result=Util.createDiagnostic(range,this.displayName+" must be one of:\n * "+enumList)}break;case"interval":if(!intervalRegExp.test(this.value)){var message=".\nFor example, "+this.example+". Supported units:\n * "+intervalUnits.join("\n * ");"updateinterval"===this.name&&/^\d+$/.test(this.value)?result=Util.createDiagnostic(range,"Specifying the interval in seconds is deprecated.\nUse `count unit` format"+message,vscodeLanguageserverTypes.DiagnosticSeverity.Warning):this.enum.length>0?this.findIndexInEnum(this.value)<0&&(result=Util.createDiagnostic(range,"Use "+this.enum.sort().join(", ")+" or `count unit` format"+message)):result=Util.createDiagnostic(range,this.displayName+" should be set as `count unit`"+message)}break;case"date":text=this.value,calendarRegExp.test(text)||localDateRegExp.test(text)||zonedDateRegExp.test(text)||(result=Util.createDiagnostic(range,this.displayName+" should be a date. For example, "+this.example));break;case"object":try{JSON.parse(this.value)}catch(err){result=Util.createDiagnostic(range,"Invalid object specified: "+err.message)}break;default:throw new Error(this.type+" is not handled")}return result},Setting.prototype.checkNumber=function(reg,message,range){var example=" For example, "+this.example;if(!reg.test(this.value))return Util.createDiagnostic(range,""+message+example);var minValue="object"==typeof this.minValue?this.minValue.value:this.minValue,minValueExcluded="object"==typeof this.minValue&&this.minValue.excluded,maxValue="object"==typeof this.maxValue?this.maxValue.value:this.maxValue,maxValueExcluded="object"==typeof this.maxValue&&this.maxValue.excluded,left=minValueExcluded?"(":"[",right=maxValueExcluded?")":"]";return minValueExcluded&&+this.value<=minValue||+this.value<minValue||maxValueExcluded&&+this.value>=maxValue||+this.value>maxValue?Util.createDiagnostic(range,this.displayName+" should be in range "+left+minValue+", "+maxValue+right+"."+example):void 0},Setting.prototype.checkPercentile=function(range){var result,n=this.value.match(/[^percntil_()]+/);return n&&+n[0]>=0&&+n[0]<=100?/_/.test(this.value)?result=Util.createDiagnostic(range,"Underscore is deprecated, use percentile("+n[0]+") instead",vscodeLanguageserverTypes.DiagnosticSeverity.Warning):new RegExp("\\("+n[0]+"\\)").test(this.value)||(result=Util.createDiagnostic(range,"Wrong usage. Expected: percentile("+n[0]+").\nCurrent: "+this.value)):result=Util.createDiagnostic(range,"n must be a decimal number between [0, 100]. Current: "+(n?n[0]:n)),result},Setting.prototype.findIndexInEnum=function(value){return this.enum.findIndex(function(option){return new RegExp("^"+option+"$","i").test(value)})},Setting}(DefaultSetting),HoverProvider=function(){function HoverProvider(document){this.text=document.getText(),this.document=document}return HoverProvider.prototype.provideHover=function(position){var range=this.calculateRange(this.positionToOffset(position));if(null===range)return null;var word=this.text.substring(range.start,range.end),name=Setting.clearSetting(word),setting=LanguageService.getResourcesProvider().getSetting(name);return null==setting||null==setting.description?null:{contents:setting.toString(),range:vscodeLanguageserverTypes.Range.create(this.offsetToPosition(range.start),this.offsetToPosition(range.end))}},HoverProvider.prototype.positionToOffset=function(position){return this.document.offsetAt(position)},HoverProvider.prototype.offsetToPosition=function(offset){return this.document.positionAt(offset)},HoverProvider.prototype.lineLimits=function(position){return{end:this.positionToOffset(vscodeLanguageserverTypes.Position.create(position.line+1,0))-1,start:this.positionToOffset(vscodeLanguageserverTypes.Position.create(position.line,0))}},HoverProvider.prototype.calculateRange=function(offset){var lineLimits=this.lineLimits(this.offsetToPosition(offset)),line=this.text.substring(lineLimits.start,lineLimits.end),match=/\S.+?(?=\s*?=)/.exec(line);if(null===match)return null;var start=lineLimits.start+match.index,end=start+match[0].length;return offset>=start&&offset<=end?{end:end,start:start}:null},HoverProvider}(),LanguageService=function(){function LanguageService(){}return LanguageService.initialize=function(resourcesProvider){LanguageService.resourcesProvider=resourcesProvider},LanguageService.getResourcesProvider=function(){if(void 0===LanguageService.resourcesProvider)throw new Error("LanguageService wasn't properly initialized with ResourcesProvider");return LanguageService.resourcesProvider},LanguageService.getCompletionProvider=function(textDocument,position){return new CompletionProvider(textDocument,position)},LanguageService.getValidator=function(text){return new Validator(text)},LanguageService.getHoverProvider=function(document){return new HoverProvider(document)},LanguageService.getFormatter=function(text,formattingOptions){return new Formatter(text,formattingOptions)},LanguageService}(),CompletionProvider=function(){function CompletionProvider(textDocument,position){var text=textDocument.getText().substr(0,textDocument.offsetAt(position));this.text=Util.deleteScripts(Util.deleteComments(text));var textList=this.text.split("\n");this.currentLine=textList[textList.length-1]}return CompletionProvider.prototype.getCompletionItems=function(){var valueMatch=/^\s*(\S+)\s*=\s*/.exec(this.currentLine),bracketsMatch=/\s*(\[.*?)\s*/.exec(this.currentLine);return valueMatch?this.completeSettingValue(valueMatch[1]):bracketsMatch?this.completeSectionName():this.completeSnippets().concat(this.completeIf(),this.completeFor(),this.completeSettingName(),this.completeSectionName(),this.completeControlKeyWord(),this.completeEndKeyword())},CompletionProvider.prototype.completeFor=function(){for(var lastMatch,regexp=/^[ \t]*(?:list|var)[ \t]+(\S+)[ \t]*=/gm,match=regexp.exec(this.text);match;)lastMatch=match,match=regexp.exec(this.text);var collection="collection",item="item";lastMatch&&(collection=lastMatch[1]).endsWith("s")&&(item=collection.substr(0,collection.lastIndexOf("s")));var completion=vscodeLanguageserverTypes.CompletionItem.create("for");return completion.insertText="\nfor ${1:"+item+"} in ${2:"+collection+"}\n  ${3:entity = @{${1:"+item+"}}}\n  ${0}\nendfor",completion.detail="For loop",completion.kind=vscodeLanguageserverTypes.CompletionItemKind.Keyword,completion.insertTextFormat=vscodeLanguageserverTypes.InsertTextFormat.Snippet,completion},CompletionProvider.prototype.completeControlKeyWord=function(){var e_1,_a,items=[];try{for(var CONTROL_KEYWORDS_1=__values(CONTROL_KEYWORDS),CONTROL_KEYWORDS_1_1=CONTROL_KEYWORDS_1.next();!CONTROL_KEYWORDS_1_1.done;CONTROL_KEYWORDS_1_1=CONTROL_KEYWORDS_1.next()){var keyword=CONTROL_KEYWORDS_1_1.value;items.push(this.fillCompletionItem({detail:"Control keyword: "+keyword,insertText:""+keyword,kind:vscodeLanguageserverTypes.CompletionItemKind.Keyword,name:keyword}))}}catch(e_1_1){e_1={error:e_1_1}}finally{try{CONTROL_KEYWORDS_1_1&&!CONTROL_KEYWORDS_1_1.done&&(_a=CONTROL_KEYWORDS_1.return)&&_a.call(CONTROL_KEYWORDS_1)}finally{if(e_1)throw e_1.error}}return items},CompletionProvider.prototype.completeEndKeyword=function(){var keywordsRegex=new RegExp("^[ \t]*(?:"+CONTROL_KEYWORDS.join("|")+")[ \t]*","mg"),completions=[];if(/^[ \t]*(end)[ \t]*/gm.test(this.text)){for(var keywordMatch=keywordsRegex.exec(this.text),keywordLastMatch=void 0;keywordMatch;)keywordLastMatch=keywordMatch,keywordMatch=keywordsRegex.exec(this.text);if(keywordLastMatch){var keyword=keywordLastMatch[0].trim();completions.push(this.fillCompletionItem({detail:"Control keyword: "+keyword,insertText:"end"+keyword,kind:vscodeLanguageserverTypes.CompletionItemKind.Keyword}))}}return completions},CompletionProvider.prototype.completeIf=function(){for(var lastMatch,regexp=/^[ \t]*for[ \t]+(\w+)[ \t]+in/gim,endFor=/^[ \t]*endfor/gim,match=regexp.exec(this.text);match;){var end=endFor.exec(this.text);(!end||end.index<match.index)&&(lastMatch=match),match=regexp.exec(this.text)}var item="item";lastMatch&&(item=lastMatch[1]);var ifString=vscodeLanguageserverTypes.CompletionItem.create("if string");ifString.detail="if item equals text",ifString.insertText="\nif @{${1:"+item+'}} ${2:==} ${3:"item1"}\n  ${4:entity} = ${5:"item2"}\nelse\n  ${4:entity} = ${6:"item3"}\nendif\n${0}';var ifNumber=vscodeLanguageserverTypes.CompletionItem.create("if number");ifNumber.insertText="\nif @{${1:"+item+'}} ${2:==} ${3:5}\n  ${4:entity} = ${5:"item1"}\nelse\n  ${4:entity} = ${6:"item2"}\nendif\n${0}',ifNumber.detail="if item equals number";var ifElseIf=vscodeLanguageserverTypes.CompletionItem.create("if else if");return ifElseIf.detail="if item equals number else if",ifElseIf.insertText="\nif @{${1:"+item+'}} ${2:==} ${3:5}\n  ${4:entity} = ${5:"item1"}\nelseif @{${1:'+item+'}} ${6:==} ${7:6}\n  ${4:entity} = ${8:"item2"}\nelse\n  ${4:entity} = ${9:"item3"}\nendif\n${0}',[ifString,ifNumber,ifElseIf].map(function(completion){return completion.insertTextFormat=vscodeLanguageserverTypes.InsertTextFormat.Snippet,completion.kind=vscodeLanguageserverTypes.CompletionItemKind.Snippet,completion})},CompletionProvider.prototype.completeSettingName=function(){var _this=this,items=[];return Array.from(LanguageService.getResourcesProvider().settingsMap.values()).forEach(function(value){items.push(_this.fillCompletionItem({detail:(value.description?value.description+"\n":"")+"Example: "+value.example,insertText:value.displayName+" = ",kind:vscodeLanguageserverTypes.CompletionItemKind.Field,name:value.displayName}))}),items},CompletionProvider.prototype.completeSectionName=function(){var e_2,_a,items=[],sectionNames=Object.keys(ResourcesProviderBase.sectionDepthMap);try{for(var sectionNames_1=__values(sectionNames),sectionNames_1_1=sectionNames_1.next();!sectionNames_1_1.done;sectionNames_1_1=sectionNames_1.next()){var item=sectionNames_1_1.value;items.push(this.fillCompletionItem({detail:"Section name: ["+item+"]",insertText:""+item,kind:vscodeLanguageserverTypes.CompletionItemKind.Struct,name:item}))}}catch(e_2_1){e_2={error:e_2_1}}finally{try{sectionNames_1_1&&!sectionNames_1_1.done&&(_a=sectionNames_1.return)&&_a.call(sectionNames_1)}finally{if(e_2)throw e_2.error}}return items},CompletionProvider.prototype.completeSettingValue=function(settingName){var setting=LanguageService.getResourcesProvider().getSetting(settingName);if(!setting)return[];switch(setting.type){case"string":return this.completeStringSettingValue(setting);case"number":case"integer":if(setting.example)return[this.fillCompletionItem({insertText:setting.example.toString()})];break;case"boolean":return this.getItemsArray(["true","false"]);case"enum":return this.getItemsArray(setting.enum.map(function(el){return el.replace(/percentile\\.+/,"percentile(n)")}));case"interval":return this.getItemsArray.apply(this,__spread([INTERVAL_UNITS],setting.enum));case"date":return this.getItemsArray(CALENDAR_KEYWORDS,(new Date).toISOString());default:return[]}return[]},CompletionProvider.prototype.completeSnippets=function(){var _this=this,snippets=LanguageService.getResourcesProvider().readSnippets();return Object.keys(snippets).map(function(key){var insertText="string"==typeof snippets[key].body?snippets[key].body:snippets[key].body.join("\n");return _this.fillCompletionItem({insertText:insertText,detail:snippets[key].description,name:key,insertTextFormat:vscodeLanguageserverTypes.InsertTextFormat.Snippet,kind:vscodeLanguageserverTypes.CompletionItemKind.Keyword})})},CompletionProvider.prototype.completeStringSettingValue=function(setting){var _this=this,valueItems=[],scriptItems=[];return setting.possibleValues&&(valueItems=setting.possibleValues.map(function(v){return _this.fillCompletionItem({insertText:v.value,detail:v.detail})})),setting.script&&setting.script.fields.forEach(function(field){var e_3,_a;if("function"===field.type){var itemFields={insertText:"",kind:vscodeLanguageserverTypes.CompletionItemKind.Function};if(field.args){var requiredArgs=field.args.filter(function(a){return a.required}),optionalArgs=field.args.filter(function(a){return!a.required}),requiredArgsString=""+requiredArgs.map(function(field){return field.name}).join(", ");itemFields.insertText=field.name+(""!==requiredArgsString?"("+requiredArgsString+")":""),scriptItems.push(_this.fillCompletionItem(itemFields));var args="";try{for(var optionalArgs_1=__values(optionalArgs),optionalArgs_1_1=optionalArgs_1.next();!optionalArgs_1_1.done;optionalArgs_1_1=optionalArgs_1.next()){args=(""!==args?args+", ":"")+optionalArgs_1_1.value.name,itemFields.insertText=field.name+"("+(""!==requiredArgsString?requiredArgsString+", ":"")+args+")",scriptItems.push(_this.fillCompletionItem(itemFields))}}catch(e_3_1){e_3={error:e_3_1}}finally{try{optionalArgs_1_1&&!optionalArgs_1_1.done&&(_a=optionalArgs_1.return)&&_a.call(optionalArgs_1)}finally{if(e_3)throw e_3.error}}}else itemFields.insertText=field.name,scriptItems.push(_this.fillCompletionItem(itemFields))}else scriptItems.push(_this.fillCompletionItem({insertText:field.name,detail:"Type: "+field.type}))}),setting.possibleValues||""===setting.example||(valueItems=[this.fillCompletionItem({insertText:setting.example.toString(),kind:vscodeLanguageserverTypes.CompletionItemKind.Field})]),valueItems.concat(scriptItems)},CompletionProvider.prototype.fillCompletionItem=function(itemFields){var item=vscodeLanguageserverTypes.CompletionItem.create(itemFields.name||itemFields.insertText);return item.insertTextFormat=itemFields.insertTextFormat||vscodeLanguageserverTypes.InsertTextFormat.PlainText,item.kind=itemFields.kind||vscodeLanguageserverTypes.CompletionItemKind.Value,item.insertText=itemFields.insertText,item.detail=itemFields.detail||itemFields.insertText,item.sortText=item.kind.toString(),item},CompletionProvider.prototype.getItemsArray=function(processedArray){for(var e_4,_a,_this=this,additionalStrings=[],_i=1;_i<arguments.length;_i++)additionalStrings[_i-1]=arguments[_i];var items=processedArray.map(function(el){return _this.fillCompletionItem({insertText:el})});try{for(var additionalStrings_1=__values(additionalStrings),additionalStrings_1_1=additionalStrings_1.next();!additionalStrings_1_1.done;additionalStrings_1_1=additionalStrings_1.next()){var s=additionalStrings_1_1.value;items.push(this.fillCompletionItem({insertText:s}))}}catch(e_4_1){e_4={error:e_4_1}}finally{try{additionalStrings_1_1&&!additionalStrings_1_1.done&&(_a=additionalStrings_1.return)&&_a.call(additionalStrings_1)}finally{if(e_4)throw e_4.error}}return items},CompletionProvider}(),CSV_NEXT_LINE_HEADER_PATTERN=/(^[ \t]*csv[ \t]+)(\w+)[ \t]*(=)/m,CSV_INLINE_HEADER_PATTERN=/=[ \t]*$/m,CSV_FROM_URL_PATTERN=/(^[ \t]*csv[ \t]+)(\w+)[ \t]*(from)/m,BLANK_LINE_PATTERN=/^[ \t]*$/m,CSV_KEYWORD_PATTERN=/\b(csv)\b/i,ONE_LINE_SQL=/^\s*sql\s*=.*$/m,BLOCK_SQL_START_WITHOUT_LF=/(^\s*)sql\s*\S/,ONE_LINE_SCRIPT=/^\s*script(?:\s+)*=\s+(.*)$/m,BLOCK_SCRIPT_START_WITHOUT_LF=/(^\s*)script\s*\S/,BLOCK_SCRIPT_START=/(?:^\s*)script(?!([\s\S]*=))/,BLOCK_SCRIPT_END=/^\s*endscript\s*$/,RELATIONS_REGEXP=new RegExp("(^\\s*.+?)(\\s*?)("+["!=","==","=",">=","<=",">","<"].join("|")+")(\\s*)");!function(CheckPriority){CheckPriority[CheckPriority.High=0]="High",CheckPriority[CheckPriority.Low=1]="Low"}(CheckPriority||(CheckPriority={}));var TextRange=function(){function TextRange(text,range,canBeUnclosed){void 0===canBeUnclosed&&(canBeUnclosed=!1),this.priority=CheckPriority.Low,this.range=range,this.text=text,this.canBeUnclosed=canBeUnclosed}return TextRange.isCloseAble=function(line){return/^[\s\t]*(?:for|if|list|sql|var|script[\s\t]*$|csv|else|elseif)\b/.test(line)},TextRange.isClosing=function(line){return/^[\s\t]*(?:end(?:for|if|list|var|script|sql|csv)|elseif|else)\b/.test(line)},TextRange.parse=function(line,i,canBeUnclosed){var match=TextRange.KEYWORD_REGEXP.exec(line);if(null!==match){var _a=__read(match,3),indent=_a[1],keyword=_a[2];return new TextRange(keyword,Util.createRange(indent.length,keyword.length,i),canBeUnclosed)}},TextRange.canBeUnclosed=function(line){return TextRange.CAN_BE_UNCLOSED_REGEXP.some(function(regexp){return regexp.test(line)})},Object.defineProperty(TextRange.prototype,"textPriority",{set:function(value){this.priority=value},enumerable:!0,configurable:!0}),TextRange.KEYWORD_REGEXP=/^([ \t]*)(import|endvar|endcsv|endfor|elseif|endif|endscript|endlist|endsql|script|else|if|list|sql|for|csv|var)\b/i,TextRange.CAN_BE_UNCLOSED_REGEXP=[CSV_FROM_URL_PATTERN,ONE_LINE_SQL,ONE_LINE_SCRIPT],TextRange}(),Formatter=function(){function Formatter(text,formattingOptions){this.currentIndent="",this.currentLine=0,this.edits=[],this.insideKeyword=!1,this.keywordsLevels=[],this.lastKeywordIndent="",this.lastAddedParent={},this.previousSection={},this.currentSection={},this.options=formattingOptions,this.lines=text.split("\n")}return Formatter.prototype.lineByLine=function(){for(var line=this.getLine(this.currentLine);void 0!==line;line=this.nextLine())if(Util.isEmpty(line))"tags"===this.currentSection.name&&"widget"!==this.previousSection.name&&(Object.assign(this.currentSection,this.previousSection),this.decreaseIndent());else if(this.isSectionDeclaration())this.calculateSectionIndent(),this.checkIndent(),this.increaseIndent();else if(BLOCK_SCRIPT_START.test(line))this.checkIndent(),this.formatScript(),this.checkIndent();else{if(this.checkSign(),TextRange.isClosing(line)){var stackHead=this.keywordsLevels.pop();this.setIndent(stackHead),this.insideKeyword=!1,this.lastKeywordIndent=""}this.checkIndent(),TextRange.isCloseAble(line)&&this.shouldBeClosed()&&(this.keywordsLevels.push(this.currentIndent.length/Formatter.BASE_INDENT_SIZE),this.lastKeywordIndent=this.currentIndent,this.increaseIndent(),this.insideKeyword=!0)}return this.edits},Formatter.prototype.formatScript=function(){for(var line=this.nextLine(),startLine=this.currentLine,buffer=[];void 0!==line&&!BLOCK_SCRIPT_END.test(line);)buffer.push(line),line=this.nextLine();if(buffer.length){var content=buffer.join("\n"),parsedCode=esprima.parseScript(content),formattedCode=escodegen.generate(parsedCode,{format:{indent:{base:this.currentIndent.length/this.options.tabSize+1,style:" ".repeat(this.options.tabSize)}}}),endLine=this.currentLine-1,endCharacter=this.getLine(endLine).length;this.edits.push(vscodeLanguageserverTypes.TextEdit.replace(vscodeLanguageserverTypes.Range.create(startLine,0,endLine,endCharacter),formattedCode))}},Formatter.prototype.checkSign=function(){var line=this.getCurrentLine(),match=RELATIONS_REGEXP.exec(line);if(null!==match){var _a=__read(match,5),declaration=_a[1],spacesBefore=_a[2],sign=_a[3],spacesAfter=_a[4];if(" "!==spacesBefore&&this.edits.push(vscodeLanguageserverTypes.TextEdit.replace(Util.createRange(declaration.length,spacesBefore.length,this.currentLine)," "))," "!==spacesAfter){var start=line.indexOf(sign)+sign.length;this.edits.push(vscodeLanguageserverTypes.TextEdit.replace(Util.createRange(start,spacesAfter.length,this.currentLine)," "))}}},Formatter.prototype.calculateSectionIndent=function(){if(!this.match)throw new Error("this.match or/and this.current is not defined in calculateIndent");Object.assign(this.previousSection,this.currentSection),this.currentSection.name=this.match[2];var depth=ResourcesProviderBase.sectionDepthMap[this.currentSection.name];switch(depth){case 0:case 1:case 2:this.setIndent(depth-1),this.lastAddedParent={name:this.currentSection.name,indent:this.currentIndent};break;case 3:ResourcesProviderBase.isNestedToPrevious(this.currentSection.name,this.previousSection.name)?(this.currentIndent=this.previousSection.indent,this.increaseIndent()):this.setIndent(depth-1),this.insideKeyword&&this.currentIndent.length<=this.lastKeywordIndent.length&&(this.currentIndent=this.lastKeywordIndent),["series","dropdown"].includes(this.currentSection.name)&&(this.lastAddedParent={name:this.currentSection.name,indent:this.currentIndent});break;case 4:ResourcesProviderBase.isNestedToPrevious(this.currentSection.name,this.previousSection.name)?this.currentIndent=this.previousSection.indent:this.currentIndent=this.lastAddedParent.indent,this.increaseIndent()}this.currentSection.indent=this.currentIndent,this.insideKeyword&&this.increaseIndent()},Formatter.prototype.checkIndent=function(){if(this.match=/(^\s*)\S/.exec(this.getCurrentLine()),this.match&&this.match[1]!==this.currentIndent){var indent=this.match[1];this.edits.push(vscodeLanguageserverTypes.TextEdit.replace(vscodeLanguageserverTypes.Range.create(this.currentLine,0,this.currentLine,indent.length),this.currentIndent))}},Formatter.prototype.decreaseIndent=function(){if(0!==this.currentIndent.length){var newLength=this.currentIndent.length;this.options.insertSpaces?newLength-=this.options.tabSize:newLength--,this.currentIndent=this.currentIndent.substring(0,newLength)}},Formatter.prototype.getCurrentLine=function(){var line=this.getLine(this.currentLine);if(void 0===line)throw new Error("this.currentLine points to nowhere");return line},Formatter.prototype.getLine=function(i){if(!this.lastLine||this.lastLineNumber!==i){var line=this.lines[i];if(void 0===line)return;this.removeExtraSpaces(line),this.lastLine=line,this.lastLineNumber=i}return this.lastLine},Formatter.prototype.nextLine=function(){return this.getLine(++this.currentLine)},Formatter.prototype.increaseIndent=function(){var addition="\t";this.options.insertSpaces&&(addition=Array(this.options.tabSize).fill(" ").join("")),this.currentIndent+=addition},Formatter.prototype.isSectionDeclaration=function(){return this.match=/(^\s*)\[([a-z]+)\]/.exec(this.getCurrentLine()),null!==this.match},Formatter.prototype.removeExtraSpaces=function(line){var match=/ (\s +) $ /.exec(line);match&&this.edits.push(vscodeLanguageserverTypes.TextEdit.replace(vscodeLanguageserverTypes.Range.create(this.currentLine,line.length-match[1].length,this.currentLine,line.length),""))},Formatter.prototype.setIndent=function(newIndentLenth){void 0===newIndentLenth&&(newIndentLenth=0);for(var newIndent="";newIndentLenth>0;newIndentLenth--)newIndent+="  ";this.currentIndent=newIndent},Formatter.prototype.shouldBeClosed=function(){var line=this.getCurrentLine();if(TextRange.canBeUnclosed(line))return!1;if(this.match=/^[ \t]*((?:var|list|sql)|script[\s\t]*$)/.exec(line),!this.match)return!0;switch(this.match[1]){case"var":if(/=\s*(\[|\{)(|.*,)\s*$/m.test(line))return!0;break;case"list":if(/(=|,)[ \t]*$/m.test(line))return!0;break;default:return!0}return!1},Formatter.BASE_INDENT_SIZE=2,Formatter}(),ResourcesProviderBase=function(){function ResourcesProviderBase(){this.settingsMap=this.createSettingsMap()}return ResourcesProviderBase.getRequiredSectionSettingsMap=function(settingsMap){return new Map([["configuration",{sections:[["group"]]}],["series",{settings:[[settingsMap.get("entity"),settingsMap.get("value"),settingsMap.get("entities"),settingsMap.get("entitygroup"),settingsMap.get("entityexpression")],[settingsMap.get("metric"),settingsMap.get("value"),settingsMap.get("table"),settingsMap.get("attribute")]]}],["group",{sections:[["widget"]]}],["widget",{sections:[["series"]],settings:[[settingsMap.get("type")]]}],["dropdown",{settings:[[settingsMap.get("onchange"),settingsMap.get("changefield")]]}],["node",{settings:[[settingsMap.get("id")]]}]])},ResourcesProviderBase.getParents=function(section){var e_1,_a,parents=[],found=ResourcesProviderBase.parentSections.get(section);if(void 0!==found)try{for(var found_1=__values(found),found_1_1=found_1.next();!found_1_1.done;found_1_1=found_1.next()){var father=found_1_1.value;parents=parents.concat(father,this.getParents(father))}}catch(e_1_1){e_1={error:e_1_1}}finally{try{found_1_1&&!found_1_1.done&&(_a=found_1.return)&&_a.call(found_1)}finally{if(e_1)throw e_1.error}}return parents},ResourcesProviderBase.isNestedToPrevious=function(currentName,previousName){return void 0!==currentName&&void 0!==previousName&&ResourcesProviderBase.getParents(currentName).includes(previousName)},ResourcesProviderBase.isCompleteSetting=function(setting){return void 0!==setting&&void 0!==setting.displayName&&void 0!==setting.type&&void 0!==setting.example},ResourcesProviderBase.prototype.getSetting=function(name,range){var clearedName=Setting.clearSetting(name),defaultSetting=this.settingsMap.get(clearedName);if(void 0!==defaultSetting){var setting=new Setting(defaultSetting);return range&&(setting.textRange=range),setting}},ResourcesProviderBase.prototype.createSettingsMap=function(){var e_2,_a,descriptions=this.readDescriptions(),settings=this.readSettings(),map=new Map;try{for(var settings_1=__values(settings),settings_1_1=settings_1.next();!settings_1_1.done;settings_1_1=settings_1.next()){var setting=settings_1_1.value;if(ResourcesProviderBase.isCompleteSetting(setting)){var name=Setting.clearSetting(setting.displayName);Object.assign(setting,{name:name,description:descriptions.get(name)});var completeSetting=new Setting(setting);map.set(completeSetting.name,completeSetting)}}}catch(e_2_1){e_2={error:e_2_1}}finally{try{settings_1_1&&!settings_1_1.done&&(_a=settings_1.return)&&_a.call(settings_1)}finally{if(e_2)throw e_2.error}}return map},ResourcesProviderBase.widgetRequirementsByType=new Map([["console",{sections:[]}],["page",{sections:[]}],["property",{sections:[["property"]]}],["graph",{sections:[["series","node","link"]]}]]),ResourcesProviderBase.parentSections=new Map([["widget",["group","configuration"]],["series",["widget","link"]],["tag",["series"]],["tags",["series"]],["column",["widget"]],["node",["widget"]],["link",["widget"]],["option",["dropdown"]]]),ResourcesProviderBase.sectionDepthMap={configuration:0,group:1,widget:2,column:3,dropdown:3,keys:3,link:3,node:3,other:3,placeholders:3,property:3,series:3,threshold:3,option:4,properties:4,tag:4,tags:4},ResourcesProviderBase.inheritableSections=new Set(["keys","tags"]),ResourcesProviderBase}(),Config=function(){function Config(text){this.currentLineNumber=-1,this.lines=Util.deleteComments(text).toLowerCase().split("\n")}return Config.prototype.getCurrentLine=function(){return this.currentLine},Config.prototype.getLine=function(line){return line<this.lines.length&&line>=0?this.lines[line]:null},Config.prototype[Symbol.iterator]=function(){var _a,_b,line,e_1_1,e_1,_c;return __generator(this,function(_d){switch(_d.label){case 0:_d.trys.push([0,5,6,7]),_a=__values(this.lines),_b=_a.next(),_d.label=1;case 1:return _b.done?[3,4]:(line=_b.value,this.currentLine=line,this.currentLineNumber++,[4,line]);case 2:_d.sent(),_d.label=3;case 3:return _b=_a.next(),[3,1];case 4:return[3,7];case 5:return e_1_1=_d.sent(),e_1={error:e_1_1},[3,7];case 6:try{_b&&!_b.done&&(_c=_a.return)&&_c.call(_a)}finally{if(e_1)throw e_1.error}return[7];case 7:return[2]}})},Config}(),Section=function(){function Section(range,settings){this.children=[],this.scope={},this.range=range,this.name=range.text,this.settings=settings}return Section.prototype.applyScope=function(){var e_1,_a;void 0!==this.parent&&(this.scope=Object.create(this.parent.scope));try{for(var _b=__values(this.settings),_c=_b.next();!_c.done;_c=_b.next()){var setting=_c.value;"type"===setting.name?this.scope.widgetType=setting.value:"mode"===setting.name&&(this.scope.mode=setting.value)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}},Section.prototype.getSetting=function(name){var cleared=Setting.clearSetting(name);return this.settings.find(function(s){return s.name===cleared})},Section.prototype.getSettingFromTree=function(settingName){for(var currentSection=this;currentSection;){var value=currentSection.getSetting(settingName);if(void 0!==value)return value;currentSection=currentSection.parent}},Section.prototype.getScopeValue=function(settingName){return"type"===settingName?this.scope.widgetType:this.scope.mode},Section.prototype.matchesConditions=function(conditions){var e_2,_a;if(void 0===conditions)return!0;try{for(var conditions_1=__values(conditions),conditions_1_1=conditions_1.next();!conditions_1_1.done;conditions_1_1=conditions_1.next()){if(!(0,conditions_1_1.value)(this))return!1}}catch(e_2_1){e_2={error:e_2_1}}finally{try{conditions_1_1&&!conditions_1_1.done&&(_a=conditions_1.return)&&_a.call(conditions_1)}finally{if(e_2)throw e_2.error}}return!0},Section}(),ConfigTree=function(){function ConfigTree(){}return Object.defineProperty(ConfigTree.prototype,"getRoot",{get:function(){return this.root},enumerable:!0,configurable:!0}),ConfigTree.prototype.addSection=function(range,settings){var section=new Section(range,settings),depth=ResourcesProviderBase.sectionDepthMap[range.text];if(!(depth>0)||this.root){switch(depth){case 0:this.root=section,this.lastAddedParent=section;break;case 1:section.parent=this.root,this.lastAddedParent=section;break;case 2:if(!(group=this.root.children[this.root.children.length-1]))return;section.parent=group,this.lastAddedParent=section;break;case 3:if(this.lastAddedParent&&"column"===this.lastAddedParent.name&&"series"===range.text)section.parent=this.lastAddedParent;else{var group;if(!(group=this.root.children[this.root.children.length-1]))return;var widget=group.children[group.children.length-1];if(!widget)return;section.parent=widget,this.lastAddedParent=section}break;case 4:if(ResourcesProviderBase.isNestedToPrevious(range.text,this.previous.name)?section.parent=this.previous:section.parent=this.lastAddedParent,!section.parent)return}section.parent&&section.parent.children.push(section),this.previous=section,section.applyScope()}},ConfigTree}(),frequentlyUsed=["mode","type"];function getValueOfCheckedSetting(settingName,section){var value;if(frequentlyUsed.includes(settingName))value=section.getScopeValue(settingName);else{var setting=section.getSettingFromTree(settingName);void 0===setting?void 0!==(setting=LanguageService.getResourcesProvider().getSetting(settingName))&&(value=setting.defaultValue):value=setting.value}return value}function requiredCondition(settingName,possibleValues){return function(section){var value=getValueOfCheckedSetting(settingName,section);return!value||new RegExp(possibleValues.join("|")).test(value.toString())}}function isNotUselessIf(settingName,possibleValues){return function(section){var value=getValueOfCheckedSetting(settingName,section);return!value||new RegExp(possibleValues.join("|")).test(value.toString())?null:possibleValues.length>1?settingName+" is one of "+possibleValues.join(", "):settingName+" is "+possibleValues[0]}}var checks=new Map([["forecast-arima-auto-regression-interval",[isNotUselessIf("type",["chart"]),isNotUselessIf("forecast-arima-auto",["false"])]],["forecast-arima-d",[isNotUselessIf("type",["chart"]),isNotUselessIf("forecast-arima-auto",["false"])]],["forecast-arima-p",[isNotUselessIf("type",["chart"]),isNotUselessIf("forecast-arima-auto",["false"])]],["forecast-hw-alpha",[isNotUselessIf("type",["chart"]),isNotUselessIf("forecast-hw-auto",["false"])]],["forecast-hw-beta",[isNotUselessIf("type",["chart"]),isNotUselessIf("forecast-hw-auto",["false"])]],["forecast-hw-gamma",[isNotUselessIf("type",["chart"]),isNotUselessIf("forecast-hw-auto",["false"])]]]);function getRule(checksMap){return function(section){var diagnostics=[];return checksMap.forEach(function(conditions,dependent){var dependentSetting=section.getSettingFromTree(dependent);if(void 0!==dependentSetting){var msg=conditions.map(function(condition){return condition(section)}).filter(function(m){return m});msg.length>0&&diagnostics.push(Util.createDiagnostic(dependentSetting.textRange,uselessScope(dependentSetting.displayName,""+msg.join(", ")),vscodeLanguageserverTypes.DiagnosticSeverity.Warning))}}),diagnostics}}var _a,noUselessSettingsForWidget={check:getRule(new Map([["negative-style",[isNotUselessIf("type",["chart"]),isNotUselessIf("mode",["column-stack","column"])]],["current-period-style",[isNotUselessIf("type",["chart"]),isNotUselessIf("mode",["column-stack","column"])]],["moving-average",[isNotUselessIf("type",["chart"]),isNotUselessIf("server-aggregate",["false"])]],["ticks",[isNotUselessIf("type",["calendar","treemap","gauge"]),isNotUselessIf("mode",["half","default"])]],["color-range",[isNotUselessIf("type",["calendar","treemap","gauge"]),isNotUselessIf("mode",["half","default"])]],["gradient-count",[isNotUselessIf("type",["calendar","treemap","gauge"]),isNotUselessIf("mode",["half","default"])]]])),name:"Checks absence of useless settings in [widget]"},noUselessSettingsForSeries={check:getRule(checks),name:"Checks absence of useless settings in [series]"},checks$2=new Map([["colors",{conditions:[requiredCondition("type",["calendar","treemap","gauge"]),requiredCondition("mode",["half","default"])],requiredSetting:"thresholds"}],["forecast-style",{conditions:[requiredCondition("type",["chart"]),requiredCondition("mode",["column","column-stack"])],requiredSetting:"data-type"}],["forecast-horizon-start-time",{conditions:[requiredCondition("type",["chart"])],requiredSetting:["forecast-horizon-end-time","forecast-horizon-interval","forecast-horizon-length"]}],["table",{requiredSetting:"attribute"}],["attribute",{requiredSetting:"table"}],["column-alert-style",{conditions:[requiredCondition("type",["bar"])],requiredSetting:"column-alert-expression"}],["alert-style",{requiredSetting:"alert-expression"}],["link-alert-style",{conditions:[requiredCondition("type",["graph"])],requiredSetting:"alert-expression"}],["node-alert-style",{conditions:[requiredCondition("type",["graph"])],requiredSetting:"alert-expression"}],["icon-alert-style",{conditions:[requiredCondition("type",["pie","text"])],requiredSetting:"icon-alert-expression"}],["icon-alert-expression",{conditions:[requiredCondition("type",["pie"])],requiredSetting:"icon"}],["icon-color",{conditions:[requiredCondition("type",["text"])],requiredSetting:"icon"}],["icon-position",{conditions:[requiredCondition("type",["text"])],requiredSetting:"icon"}],["icon-size",{conditions:[requiredCondition("type",["text"])],requiredSetting:"icon"}],["caption-style",{conditions:[requiredCondition("type",["pie","gauge"])],requiredSetting:"caption"}]]),rulesBySection=new Map([["series",[{name:"Checks colors is less than thresholds by 1",check:function(section){var colorsValues,thresholdsValues;if(section.matchesConditions([requiredCondition("type",["calendar","treemap","gauge"]),requiredCondition("mode",["half","default"])])){var colorsSetting=section.getSettingFromTree("colors");if(void 0!==colorsSetting){var thresholdsSetting=section.getSettingFromTree("thresholds");if(void 0===thresholdsSetting)return Util.createDiagnostic(section.range.range,"thresholds is required if colors is specified");colorsSetting.values.length>0?(colorsSetting.values.push(colorsSetting.value),colorsValues=colorsSetting.values):colorsValues=(colorsValues=colorsSetting.value.replace(/(\s*\d{3}\s*,?)/g,"")).split(",").filter(function(s){return""!==s.trim()}),thresholdsSetting.values.length>0?(thresholdsSetting.values.push(thresholdsSetting.value),thresholdsValues=thresholdsSetting.values):thresholdsValues=thresholdsSetting.value.split(",").filter(function(s){return""!==s.trim()});var expected=thresholdsValues.length-1;return colorsValues.length!==expected?Util.createDiagnostic(colorsSetting.textRange,"Number of colors (if specified) must be equal to\nnumber of thresholds minus 1.\nCurrent: "+(""+colorsValues.length)+", expected: "+(""+expected)):void 0}}}},{name:"Checks forecast-horizon-end-time is greater than end-time",check:function(section){var forecast=section.getSettingFromTree("forecast-horizon-end-time");if(void 0!==forecast){var end=section.getSettingFromTree("end-time");if(void 0!==end)return end.value>=forecast.value?Util.createDiagnostic(end.textRange,forecast.displayName+" must be greater than "+end.displayName,vscodeLanguageserverTypes.DiagnosticSeverity.Error):void 0}}},{name:"Checks forecast-ssa-group-auto-count is greater than forecast-ssa-decompose-eigentriple-limit",check:function(section){var groupAutoCount=section.getSettingFromTree("forecast-ssa-group-auto-count");if(void 0!==groupAutoCount){var forecastLimit=section.getSettingFromTree("forecast-ssa-decompose-eigentriple-limit");return(forecastLimit?forecastLimit.value:LanguageService.getResourcesProvider().getSetting("forecast-ssa-decompose-eigentriple-limit").defaultValue)<=groupAutoCount.value?Util.createDiagnostic(groupAutoCount.textRange,"forecast-ssa-group-auto-count must be less than forecast-ssa-decompose-eigentriple-limit (default 0)"):void 0}}},{name:"Checks presence of required setting if dependent is specified",check:function(section){var diagnostics=[];return checks$2.forEach(function(requirement,dependent){var e_1,_a;if(section.matchesConditions(requirement.conditions)&&void 0!==section.getSettingFromTree(dependent)){var required,msg,reqNames=requirement.requiredSetting;if(Array.isArray(reqNames)){try{for(var reqNames_1=__values(reqNames),reqNames_1_1=reqNames_1.next();!reqNames_1_1.done;reqNames_1_1=reqNames_1.next()){var displayName=reqNames_1_1.value;if(required=section.getSettingFromTree(displayName))break}}catch(e_1_1){e_1={error:e_1_1}}finally{try{reqNames_1_1&&!reqNames_1_1.done&&(_a=reqNames_1.return)&&_a.call(reqNames_1)}finally{if(e_1)throw e_1.error}}msg=function(dependent,required){return dependent+" has effect only with one of the following:\n * "+required.join("\n * ")}(dependent,reqNames)}else required=section.getSettingFromTree(reqNames),msg=function(dependent,required){return required+" is required if "+dependent+" is specified"}(dependent,reqNames);void 0===required&&diagnostics.push(Util.createDiagnostic(section.range.range,msg))}}),diagnostics}},noUselessSettingsForSeries]],["widget",[{name:"Checks start-time is greater than end-time",check:function(section){var end=section.getSettingFromTree("end-time"),start=section.getSettingFromTree("start-time");if(void 0!==end&&void 0!==start)return start.value>=end.value?Util.createDiagnostic(end.textRange,end.displayName+" must be greater than "+start.displayName,vscodeLanguageserverTypes.DiagnosticSeverity.Error):void 0}},noUselessSettingsForWidget]]]),ConfigTreeValidator=function(){function ConfigTreeValidator(){}return ConfigTreeValidator.validate=function(onfigTree){var walker=new ConfigTreeWalker(onfigTree),diagnostics=[];return rulesBySection.forEach(function(rulesForSection,sectionName){var sectionsToCheck=walker.getSectionsByName(sectionName);sectionsToCheck.length>0&&sectionsToCheck.forEach(function(section){rulesForSection.forEach(function(rule){var diag=rule.check(section);diag&&(Array.isArray(diag)?diagnostics.push.apply(diagnostics,__spread(diag)):diagnostics.push(diag))})})}),diagnostics},ConfigTreeValidator}(),ConfigTreeWalker=function(){function ConfigTreeWalker(onfigTree){this.requestedSections=[],this.tree=onfigTree}return ConfigTreeWalker.prototype.getSectionsByName=function(sectionName){return this.tree.getRoot&&this.walk(sectionName,this.tree.getRoot),this.requestedSections},ConfigTreeWalker.prototype.walk=function(targetSection,startSection){var e_1,_a;try{for(var _b=__values(startSection.children),_c=_b.next();!_c.done;_c=_b.next()){var section=_c.value;section.name===targetSection?this.requestedSections.push(section):this.walk(targetSection,section)}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_1)throw e_1.error}}},ConfigTreeWalker}(),KeywordHandler=function(){function KeywordHandler(keywordsStack){this.diagnostics=[],this.keywordsStack=keywordsStack}return KeywordHandler.prototype.handleSql=function(line,foundKeyword){if(!ONE_LINE_SQL.test(line)){this.keywordsStack.push(foundKeyword);var match=BLOCK_SQL_START_WITHOUT_LF.exec(line);null!==match&&this.diagnostics.push(Util.createDiagnostic(Util.createRange(match[1].length,"sql".length,foundKeyword.range.start.line),lineFeedRequired("sql")))}},KeywordHandler.prototype.handleIf=function(line,foundKeyword){var ifCondition=/^[\s].*if\s*(.*)/.exec(line)[1];if(""!==ifCondition.trim())try{Function("return "+ifCondition)}catch(err){this.diagnostics.push(Util.createDiagnostic(Util.createRange(line.indexOf(ifCondition),ifCondition.length,foundKeyword.range.start.line),err.message))}else this.diagnostics.push(Util.createDiagnostic(foundKeyword.range,"If condition can not be empty"))},KeywordHandler.prototype.handleScript=function(line,foundKeyword){if(!ONE_LINE_SCRIPT.test(line)){this.keywordsStack.push(foundKeyword);var match=BLOCK_SCRIPT_START_WITHOUT_LF.exec(line);null!==match&&this.diagnostics.push(Util.createDiagnostic(Util.createRange(match[1].length,"script".length,foundKeyword.range.start.line),lineFeedRequired("script")))}},KeywordHandler}(),SectionStackNode=function(){function SectionStackNode(range){this.range=range,this.dependencies=[],this.settings=[];var settingsMap=LanguageService.getResourcesProvider().settingsMap,deps=ResourcesProviderBase.getRequiredSectionSettingsMap(settingsMap).get(this.name);deps&&deps.sections&&this.setRequiredSections(deps.sections)}return SectionStackNode.prototype.setRequiredSections=function(sections){var e_1,_a;this.dependencies.splice(0,this.dependencies.length);try{for(var sections_1=__values(sections),sections_1_1=sections_1.next();!sections_1_1.done;sections_1_1=sections_1.next()){var option=sections_1_1.value;this.dependencies.push({resolvedCount:0,unresolved:option.slice()})}}catch(e_1_1){e_1={error:e_1_1}}finally{try{sections_1_1&&!sections_1_1.done&&(_a=sections_1.return)&&_a.call(sections_1)}finally{if(e_1)throw e_1.error}}},SectionStackNode.prototype.insertSetting=function(setting){this.settings.push(setting)},SectionStackNode.prototype.getSetting=function(name){var cleared=Setting.clearSetting(name);return this.settings.find(function(s){return s.name===cleared})},SectionStackNode.prototype.resolveDependency=function(name){var e_2,_a;try{for(var _b=__values(this.dependencies),_c=_b.next();!_c.done;_c=_b.next()){var option=_c.value,index=option.unresolved.indexOf(name);index>=0&&(option.resolvedCount++,option.unresolved.splice(index,1))}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_2)throw e_2.error}}},Object.defineProperty(SectionStackNode.prototype,"dependenciesResolved",{get:function(){return 0===this.dependencies.length||this.dependencies.some(function(deps){return 0===deps.unresolved.length})},enumerable:!0,configurable:!0}),Object.defineProperty(SectionStackNode.prototype,"name",{get:function(){return this.range.text},enumerable:!0,configurable:!0}),Object.defineProperty(SectionStackNode.prototype,"unresolved",{get:function(){return 0===this.dependencies.length?[]:this.dependencies.reduce(function(best,dep){return dep.resolvedCount>best.resolvedCount?dep:dep.unresolved.length<best.unresolved.length?dep:best}).unresolved},enumerable:!0,configurable:!0}),SectionStackNode}(),DummySectionStackNode=((_a={dependencies:[],dependenciesResolved:!0,name:"",range:new TextRange("",vscodeLanguageserverTypes.Range.create(vscodeLanguageserverTypes.Position.create(0,0),vscodeLanguageserverTypes.Position.create(0,0))),settings:[],unresolved:[],resolveDependency:function(){},setRequiredSections:function(){},getSetting:function(){},insertSetting:function(){}})[Symbol.toStringTag]="DummySectionStackNode",_a),SectionStack=function(){function SectionStack(){this.stack=[]}return SectionStack.prototype.insertSection=function(section){var e_3,_a,sectionName=section.text,_b=__read(this.checkAndGetDepth(section),2),depth=_b[0],error=_b[1];if(depth<this.stack.length){if(0===depth)return this.createErrorDiagnostic(section,"Unexpected section ["+sectionName+"].");error=this.checkDependenciesResolved(depth),this.stack.splice(depth,this.stack.length-depth)}for(var i=this.stack.length;i<depth;i++)this.stack.push(DummySectionStackNode);try{for(var _c=__values(this.stack),_d=_c.next();!_d.done;_d=_c.next()){_d.value.resolveDependency(sectionName)}}catch(e_3_1){e_3={error:e_3_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_3)throw e_3.error}}return this.stack.push(new SectionStackNode(section)),error},SectionStack.prototype.getLastSection=function(){return this.stack[this.stack.length-1]},SectionStack.prototype.finalize=function(){var err=this.checkDependenciesResolved(0);return this.stack=[],err},SectionStack.prototype.requireSections=function(targetSection){for(var e_4,_a,e_5,_b,sections=[],_i=1;_i<arguments.length;_i++)sections[_i-1]=arguments[_i];var target=this.stack.find(function(s){return s.name===targetSection});if(target){try{for(var _c=__values(target.dependencies),_d=_c.next();!_d.done;_d=_c.next()){var dep=_d.value;try{for(var sections_2=(e_5=void 0,__values(sections)),sections_2_1=sections_2.next();!sections_2_1.done;sections_2_1=sections_2.next()){var section=sections_2_1.value;dep.unresolved.includes(section)||dep.unresolved.push(section)}}catch(e_5_1){e_5={error:e_5_1}}finally{try{sections_2_1&&!sections_2_1.done&&(_b=sections_2.return)&&_b.call(sections_2)}finally{if(e_5)throw e_5.error}}}}catch(e_4_1){e_4={error:e_4_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_4)throw e_4.error}}0===target.dependencies.length&&target.dependencies.push({resolvedCount:0,unresolved:sections})}},SectionStack.prototype.setSectionRequirements=function(targetSection,sections){var target=this.stack.find(function(s){return s.name===targetSection});target&&target.setRequiredSections(sections)},SectionStack.prototype.insertCurrentSetting=function(setting){this.stack.length>0&&this.stack[this.stack.length-1].insertSetting(setting)},SectionStack.prototype.getCurrentSetting=function(name,recursive){void 0===recursive&&(recursive=!0);for(var i=recursive?this.stack.length:1;i>0;){var value=this.stack[--i].getSetting(name);if(void 0!==value)return value}},SectionStack.prototype.getSectionSettings=function(section,recursive){var e_6,_a;void 0===recursive&&(recursive=!0);var targetIdx=section?this.stack.findIndex(function(s){return s.name===section}):this.stack.length-1,result=[];if(targetIdx>=0)for(var i=recursive?0:targetIdx;i<=targetIdx;i++){var target=this.stack[i];try{for(var _b=(e_6=void 0,__values(target.settings)),_c=_b.next();!_c.done;_c=_b.next()){var setting=_c.value;result.push(setting)}}catch(e_6_1){e_6={error:e_6_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_6)throw e_6.error}}}return result},SectionStack.prototype.getSectionRange=function(section){var node=this.stack.find(function(s){return s.name===section});return node?node.range:null},SectionStack.prototype.createErrorDiagnostic=function(section,message){return Util.createDiagnostic(section.range,message,vscodeLanguageserverTypes.DiagnosticSeverity.Error)},SectionStack.prototype.checkDependenciesResolved=function(startIndex){for(var stack=this.stack,i=stack.length;i>startIndex;){var section=stack[--i];if(!section.dependenciesResolved){var unresolved=section.unresolved.map(function(s){return"["+s+"]"}),message=void 0;return message=unresolved.length>1?"Required sections "+unresolved.join(", ")+" are not declared.":"Required section "+unresolved.join(", ")+" is not declared.",this.createErrorDiagnostic(section.range,message)}}return null},SectionStack.prototype.checkAndGetDepth=function(sectionRange){var section=sectionRange.text,expectedDepth=this.stack.length,actualDepth=ResourcesProviderBase.sectionDepthMap[section],error=null;if(null==actualDepth)error=this.createErrorDiagnostic(sectionRange,"Unknown section ["+section+"].");else if(actualDepth>expectedDepth){if(ResourcesProviderBase.inheritableSections.has(section)&&expectedDepth>0)actualDepth=expectedDepth;else{var errorMessage="Unexpected section ["+section+"]. ",expectedSections=Object.entries(ResourcesProviderBase.sectionDepthMap).filter(function(_a){return __read(_a,2)[1]===expectedDepth}).map(function(_a){return"["+__read(_a,1)[0]+"]"});expectedSections.length>1?errorMessage+="Expected one of "+expectedSections.join(", ")+".":errorMessage+="Expected "+expectedSections[0]+".",error=this.createErrorDiagnostic(sectionRange,errorMessage)}}return[actualDepth,error]},SectionStack}(),placeholderContainingSettings=["url","urlparameters"],Validator=function(){function Validator(text){this.aliases=[],this.sectionStack=new SectionStack,this.currentSettings=[],this.deAliases=[],this.ifSettings=new Map,this.keywordsStack=[],this.parentSettings=new Map,this.previousSettings=[],this.requiredSettings=[],this.result=[],this.settingValues=new Map,this.variables=new Map([["freemarker",["entity","entities","type"]]]),this.lastEndIf=void 0,this.configTree=new ConfigTree,this.config=new Config(text),this.keywordHandler=new KeywordHandler(this.keywordsStack)}return Validator.prototype.lineByLine=function(){var e_1,_a,_b;try{for(var _c=__values(this.config),_d=_c.next();!_d.done;_d=_c.next()){var line=_d.value,canBeSingle=!1;CSV_KEYWORD_PATTERN.test(line)&&(canBeSingle=!CSV_INLINE_HEADER_PATTERN.test(line)&&!CSV_NEXT_LINE_HEADER_PATTERN.test(line)),this.foundKeyword=TextRange.parse(line,this.config.currentLineNumber,canBeSingle),this.isNotKeywordEnd("script")||this.isNotKeywordEnd("var")||this.isNotKeywordEnd("sql")||(this.isNotKeywordEnd("csv")&&this.validateCsv(),this.eachLine(),void 0!==this.foundKeyword&&(/\b(if|for|csv)\b/i.test(this.foundKeyword.text)&&this.keywordsStack.push(this.foundKeyword),this.switchKeyword()))}}catch(e_1_1){e_1={error:e_1_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_1)throw e_1.error}}this.checkAliases(),this.diagnosticForLeftKeywords(),this.checkRequredSettingsForSection(),this.checkUrlPlaceholders(),this.setSectionToStackAndTree(null);var rulesDiagnostics=ConfigTreeValidator.validate(this.configTree);return rulesDiagnostics=__spread(rulesDiagnostics.reduce(function(allItems,item){return allItems.has(item.range)?allItems:allItems.set(item.range,item)},new Map).values()),(_b=this.result).push.apply(_b,__spread(rulesDiagnostics)),this.result.concat(this.keywordHandler.diagnostics)},Validator.prototype.isNotKeywordEnd=function(keyword){return this.areWeIn(keyword)&&(void 0===this.foundKeyword||this.foundKeyword.text!=="end"+keyword)},Validator.prototype.addCurrentToParentSettings=function(){var e_2,_a;if(void 0!==this.currentSection)try{for(var _b=__values(this.currentSettings),_c=_b.next();!_c.done;_c=_b.next()){var setting=_c.value;this.addToParentsSettings(this.currentSection.text,setting)}}catch(e_2_1){e_2={error:e_2_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_2)throw e_2.error}}},Validator.prototype.addSettingValue=function(setting){if(null==this.match)throw new Error("Trying to add new entry to settingValues map and sectionStack based on undefined");var value=Setting.clearValue(this.match[3]);setting.value=value,this.settingValues.set(setting.name,value)},Validator.prototype.addToSettingArray=function(variable,array){var result=void 0===array?[]:array;if(null==this.match)return result;var _a=__read(this.match,3),indent=_a[1],name=_a[2];if(void 0===variable)return result;var declaredAbove=result.find(function(v){return v.name===variable.name});if(void 0!==declaredAbove){var range=this.createRange(indent.length,name.length);this.result.push(Util.repetitionDiagnostic(range,declaredAbove,variable))}else result.push(variable);return result},Validator.prototype.addToParentsSettings=function(key,setting){var array=this.parentSettings.get(key);void 0===array?array=[setting]:array.push(setting),this.parentSettings.set(key,array)},Validator.prototype.addToStringArray=function(array){var result=array;if(null==this.match)return result;var _a=__read(this.match,3),indent=_a[1],variable=_a[2];return array.includes(variable)?this.result.push(Util.createDiagnostic(this.createRange(indent.length,variable.length),variable+" is already defined")):result.push(variable),result},Validator.prototype.addToStringMap=function(map,key){if(null==this.match)return map;var _a=__read(this.match,3),indent=_a[1],variable=_a[2];if(Util.isInMap(variable,map)){var startPosition=this.match.index+indent.length;this.result.push(Util.createDiagnostic(this.createRange(startPosition,variable.length),variable+" is already defined"))}else{var array=map.get(key);void 0===array?array=[variable]:array.push(variable),map.set(key,array)}return map},Validator.prototype.areWeIn=function(name){return this.keywordsStack.some(function(textRange){return textRange.text===name})},Validator.prototype.checkAliases=function(){var _this=this;this.deAliases.forEach(function(deAlias){_this.aliases.includes(deAlias.text)||_this.result.push(Util.createDiagnostic(deAlias.range,unknownToken(deAlias.text)))})},Validator.prototype.checkEnd=function(expectedEnd){if(void 0!==this.foundKeyword){var lastKeyword=this.getLastKeyword();if(lastKeyword!==expectedEnd)if(this.areWeIn(expectedEnd)){var index=this.keywordsStack.findIndex(function(keyword){return keyword.text===expectedEnd});this.keywordsStack.splice(index,1),this.result.push(Util.createDiagnostic(this.foundKeyword.range,expectedEnd+" has finished before "+lastKeyword))}else this.result.push(Util.createDiagnostic(this.foundKeyword.range,noMatching(this.foundKeyword.text,expectedEnd)));else this.keywordsStack.pop()}},Validator.prototype.checkExcludes=function(setting){var e_3,_a;if(null!=this.match){var _b=__read(this.match,3),indent=_b[1],name=_b[2];try{for(var _c=__values(this.currentSettings),_d=_c.next();!_d.done;_d=_c.next()){var item=_d.value;if(setting.excludes.includes(item.displayName)){var range=this.createRange(indent.length,name.length);this.result.push(Util.createDiagnostic(range,setting.displayName+" can not be specified simultaneously with "+item.displayName))}}}catch(e_3_1){e_3={error:e_3_1}}finally{try{_d&&!_d.done&&(_a=_c.return)&&_a.call(_c)}finally{if(e_3)throw e_3.error}}}},Validator.prototype.checkFreemarker=function(){var line=this.config.getCurrentLine();this.match=/<\/?#.*?\/?>/.exec(line),null!==this.match&&(this.result.push(Util.createDiagnostic(this.createRange(this.match.index,this.match[0].length),"Freemarker expressions are deprecated.\nUse a native collection: list, csv table, var object.\nMigration examples are available at https://github.com/axibase/charts/blob/master/syntax/freemarker.md",vscodeLanguageserverTypes.DiagnosticSeverity.Information)),this.match=/(as\s*(\S+)>)/.exec(line),this.match&&this.addToStringArray(this.aliases))},Validator.prototype.checkRequredSettingsForSection=function(){var e_4,_a,e_5,_b,e_6,_c,e_7,_d,e_8,_e;if(void 0!==this.currentSection){this.previousSection&&/tag/i.test(this.currentSection.text)&&(this.currentSettings=this.previousSettings,this.currentSection=this.previousSection);var settingsMap=LanguageService.getResourcesProvider().settingsMap,sectionRequirements=ResourcesProviderBase.getRequiredSectionSettingsMap(settingsMap).get(this.currentSection.text);if(sectionRequirements){var required=sectionRequirements.settings;void 0!==required&&(this.requiredSettings=required.concat(this.requiredSettings));var notFound=[];try{required:for(var _f=__values(this.requiredSettings),_g=_f.next();!_g.done;_g=_f.next()){var options=_g.value,displayName=options[0].displayName;if("metric"===displayName){var columnMetric=this.settingValues.get("columnmetric"),columnValue=this.settingValues.get("columnvalue");if("null"===columnMetric&&"null"===columnValue)continue;var changeField=this.settingValues.get("changefield");if(/metric/.test(changeField))continue}var optionsNames=options.map(function(s){return s.name});if(!Util.isAnyInArray(optionsNames,this.currentSettings.map(function(s){return s.name}))){try{for(var _h=(e_5=void 0,__values(this.parentSettings.values())),_j=_h.next();!_j.done;_j=_h.next()){var array=_j.value;if(Util.isAnyInArray(optionsNames,array.map(function(s){return s.name})))continue required}}catch(e_5_1){e_5={error:e_5_1}}finally{try{_j&&!_j.done&&(_b=_h.return)&&_b.call(_h)}finally{if(e_5)throw e_5.error}}if(this.ifSettings.size>0){try{for(var _k=(e_6=void 0,__values(this.ifSettings.values())),_l=_k.next();!_l.done;_l=_k.next()){array=_l.value;if(!Util.isAnyInArray(optionsNames,array.map(function(s){return s.name}))){notFound.push(displayName);continue required}}}catch(e_6_1){e_6={error:e_6_1}}finally{try{_l&&!_l.done&&(_c=_k.return)&&_c.call(_k)}finally{if(e_6)throw e_6.error}}var curSectLine=this.currentSection.range.end.line,lastCondLine=parseInt(this.lastCondition.match(/^\d+/)[0],10);if(this.areWeIn("if")||curSectLine<this.lastEndIf&&curSectLine>lastCondLine)continue;var ifCounter=0,elseCounter=0;try{for(var _m=(e_7=void 0,__values(this.ifSettings.keys())),_o=_m.next();!_o.done;_o=_m.next()){var statement=_o.value;/\bif\b/.test(statement)?ifCounter++:/\belse\b/.test(statement)&&elseCounter++}}catch(e_7_1){e_7={error:e_7_1}}finally{try{_o&&!_o.done&&(_d=_m.return)&&_d.call(_m)}finally{if(e_7)throw e_7.error}}if(ifCounter===elseCounter)continue}notFound.push(displayName)}}}catch(e_4_1){e_4={error:e_4_1}}finally{try{_g&&!_g.done&&(_a=_f.return)&&_a.call(_f)}finally{if(e_4)throw e_4.error}}try{for(var notFound_1=__values(notFound),notFound_1_1=notFound_1.next();!notFound_1_1.done;notFound_1_1=notFound_1.next()){var option=notFound_1_1.value;this.result.push(Util.createDiagnostic(this.currentSection.range,option+" is required"))}}catch(e_8_1){e_8={error:e_8_1}}finally{try{notFound_1_1&&!notFound_1_1.done&&(_e=notFound_1.return)&&_e.call(notFound_1)}finally{if(e_8)throw e_8.error}}this.requiredSettings.splice(0,this.requiredSettings.length)}}},Validator.prototype.checkRepetition=function(setting){if(null!=this.match){var _a=__read(this.match,3),indent=_a[1],name=_a[2],range=this.createRange(indent.length,name.length);if(this.areWeIn("if")){if(void 0===this.lastCondition)throw new Error("We are in if, but last condition is undefined");var array=this.ifSettings.get(this.lastCondition);array=this.addToSettingArray(setting,array),this.ifSettings.set(this.lastCondition,array);var declaredAbove=this.currentSettings.find(function(v){return v.name===setting.name});if(void 0!==declaredAbove)return void this.result.push(Util.repetitionDiagnostic(range,declaredAbove,setting))}else this.addToSettingArray(setting,this.currentSettings);this.sectionStack.insertCurrentSetting(setting)}},Validator.prototype.diagnosticForLeftKeywords=function(){var e_9,_a;try{for(var _b=__values(this.keywordsStack),_c=_b.next();!_c.done;_c=_b.next()){var nestedConstruction=_c.value;nestedConstruction.canBeUnclosed||this.result.push(Util.createDiagnostic(nestedConstruction.range,noMatching(nestedConstruction.text,"end"+nestedConstruction.text)))}}catch(e_9_1){e_9={error:e_9_1}}finally{try{_c&&!_c.done&&(_a=_b.return)&&_a.call(_b)}finally{if(e_9)throw e_9.error}}},Validator.prototype.eachLine=function(){this.checkFreemarker();var line=this.config.getCurrentLine();this.match=/(^[\t ]*\[)(\w+)\][\t ]*/.exec(line),null!==this.match||0===line.trim().length&&void 0!==this.currentSection&&"tags"===this.currentSection.text?(null!==this.match&&this.spellingCheck(),this.handleSection()):(this.match=/(^\s*)([a-z].*?[a-z])\s*=\s*(.*?)\s*$/.exec(line),null!==this.match&&(this.checkSettingsWhitespaces(),this.handleSettings(),this.areWeIn("for")&&this.validateFor()),this.match=/(^\s*\[)(\w+)\s*$/.exec(line),null!==this.match&&this.result.push(Util.createDiagnostic(this.createRange(this.match[1].length,this.match[2].length),"Section tag is unclosed")))},Validator.prototype.findDeAliases=function(){var freemarkerExpr,deAlias,line=this.config.getCurrentLine(),regexp=/value\((['"])(\S+?)\1\)/g;for(this.match=regexp.exec(line);null!==this.match;)deAlias=this.match[2],(freemarkerExpr=/(\$\{(\S+)\})/.exec(deAlias))&&(deAlias=freemarkerExpr[2]),this.deAliases.push(new TextRange(deAlias,this.createRange(line.indexOf(deAlias),deAlias.length))),this.match=regexp.exec(line)},Validator.prototype.getLastKeyword=function(){if(0!==this.keywordsStack.length)return this.keywordsStack[this.keywordsStack.length-1].text},Validator.prototype.getSettingCheck=function(){if(null!=this.match){var settingName=this.match[2],setting=this.getSetting(settingName);if(void 0!==setting)return setting=setting.applyScope({section:this.currentSection?this.currentSection.text.trim():"",widget:this.currentWidget||""});if(/column-/.test(settingName))return;if(TextRange.KEYWORD_REGEXP.test(settingName))return;if(void 0!==this.currentSection&&("placeholders"===this.currentSection.text||"properties"===this.currentSection.text))return setting=new Setting(new DefaultSetting),Object.assign(setting,{name:settingName,section:this.currentSection.text}),setting;var message=unknownToken(settingName);this.result.push(Util.createDiagnostic(this.createRange(this.match[1].length,settingName.length),message))}},Validator.prototype.handleCsv=function(){var line=this.config.getCurrentLine(),header=null;if(CSV_INLINE_HEADER_PATTERN.exec(line)){var j=this.config.currentLineNumber+1;for(header=this.config.getLine(j);null!==header&&BLANK_LINE_PATTERN.test(header);)header=this.config.getLine(++j)}else{var match=CSV_NEXT_LINE_HEADER_PATTERN.exec(line)||CSV_FROM_URL_PATTERN.exec(line);null!==match?(this.match=match,header=line.substring(this.match.index+1)):this.result.push(Util.createDiagnostic(this.foundKeyword.range,function(line){return CSV_FROM_URL_MISSING_NAME_PATTERN.test(line)?"<name> in 'csv <name> from <url>' is missing":"The line should contain a '=' or 'from' keyword"}(line)))}this.addToStringMap(this.variables,"csvNames"),this.csvColumns=null===header?0:Util.countCsvColumns(header)},Validator.prototype.handleElse=function(){if(void 0===this.foundKeyword)throw new Error("We're trying to handle 'else ', but foundKeyword is "+this.foundKeyword);var message;this.setLastCondition(),this.areWeIn("if")?"if"!==this.getLastKeyword()&&(message=this.foundKeyword.text+" has started before "+this.getLastKeyword()+" has finished"):message=noMatching(this.foundKeyword.text,"if"),void 0!==message&&this.result.push(Util.createDiagnostic(this.foundKeyword.range,message))},Validator.prototype.handleEndFor=function(){var forVariables=this.variables.get("forVariables");void 0===forVariables?forVariables=[]:forVariables.pop(),this.variables.set("forVariables",forVariables)},Validator.prototype.handleFor=function(){var e_10,_a,line=this.config.getCurrentLine();if(this.match=/(^\s*for\s+)(\w+)\s+in\s*/m.exec(line),null!=this.match){var collection=line.substring(this.match[0].length).trim();if(""!==collection){var varName=void 0;try{for(var regs_1=__values([/^Object\.keys\((\w+)(?:\.\w+)*\)$/i,/^(\w+)\.values\((["'])\w+\2\)$/i,/^(\w+)(\[\d+\])*$/i]),regs_1_1=regs_1.next();!regs_1_1.done;regs_1_1=regs_1.next()){var matched=regs_1_1.value.exec(collection);if(varName=matched?matched[1]:null)break}}catch(e_10_1){e_10={error:e_10_1}}finally{try{regs_1_1&&!regs_1_1.done&&(_a=regs_1.return)&&_a.call(regs_1)}finally{if(e_10)throw e_10.error}}if(varName){if(!Util.isInMap(varName,this.variables)){var message=unknownToken(varName);start=line.lastIndexOf(varName);this.result.push(Util.createDiagnostic(this.createRange(start,varName.length),message))}}else try{Function("return "+collection)}catch(err){var start=line.indexOf(collection);this.result.push(Util.createDiagnostic(this.createRange(start,collection.length),"Incorrect collection declaration."))}}else{start=this.match[0].indexOf("in");this.result.push(Util.createDiagnostic(this.createRange(start,"in".length),"Empty 'in' statement"))}this.addToStringMap(this.variables,"forVariables")}},Validator.prototype.handleList=function(){if(void 0===this.foundKeyword)throw new Error("We're trying to handle 'list', but foundKeyword is undefined");var line=this.config.getCurrentLine();if(this.match=/(^\s*list\s+)(\w+)\s*=/.exec(line),this.addToStringMap(this.variables,"listNames"),/(=|,)[ \t]*$/m.test(line))this.keywordsStack.push(this.foundKeyword);else{for(var j=this.config.currentLineNumber+1,nextLine=this.config.getLine(j);null!==nextLine&&/^[ \t]*$/m.test(nextLine);)nextLine=this.config.getLine(++j);null!==nextLine&&(/^[ \t]*,/.test(nextLine)||/\bendlist\b/.test(nextLine))&&this.keywordsStack.push(this.foundKeyword)}},Validator.prototype.handleSection=function(){if(null!=this.match){var _a=__read(this.match,3),indent=_a[1],name=_a[2];this.currentSection&&/tag/i.test(name)||(this.checkRequredSettingsForSection(),this.addCurrentToParentSettings(),/widget/i.test(name)&&(this.checkAliases(),this.deAliases.splice(0,this.deAliases.length),this.aliases.splice(0,this.aliases.length),this.settingValues.clear()),this.checkUrlPlaceholders(),this.ifSettings.clear()),this.previousSettings=this.currentSettings.splice(0,this.currentSettings.length),this.previousSection=this.currentSection,this.currentSection=new TextRange(name,this.createRange(indent.length,name.length)),this.parentSettings.delete(this.currentSection.text),this.setSectionToStackAndTree(this.currentSection)}else void 0!==this.previousSection&&(this.currentSection=this.previousSection,this.currentSettings=this.previousSettings)},Validator.prototype.setSectionToStackAndTree=function(section){var sectionStackError,lastSection=this.sectionStack.getLastSection();lastSection&&this.configTree.addSection(lastSection.range,lastSection.settings),(sectionStackError=null==section?this.sectionStack.finalize():this.sectionStack.insertSection(this.currentSection))&&this.result.push(sectionStackError)},Validator.prototype.handleSettings=function(){if(null!=this.match){var line=this.config.getCurrentLine();if(void 0!==this.currentSection&&/(?:tag|key)s?/.test(this.currentSection.text)){if(/(?:tag|key)s?/.test(this.currentSection.text)&&/(^[ \t]*)([a-z].*?[a-z])[ \t]*=/.test(line)){if(this.match=/(^[ \t]*)([a-z].*?[a-z])[ \t]*=/.exec(line),null===this.match)return;var _a=__read(this.match,3),indent=_a[1],name=_a[2],setting=this.getSetting(name);this.isAllowedWidget(setting)&&this.result.push(Util.createDiagnostic(this.createRange(indent.length,name.length),name+" is interpreted as a series tag and is sent to the\nserver. Move the setting outside of the [tags] section or\nenclose in double-quotes to send it to the server without\na warning.",vscodeLanguageserverTypes.DiagnosticSeverity.Information))}}else this.handleRegularSetting()}},Validator.prototype.isAllowedWidget=function(setting){return void 0!==setting&&"tag"!==this.currentSection.text&&(null==setting.widget||void 0===this.currentWidget||setting.widget===this.currentWidget)},Validator.prototype.isAllowedInSection=function(setting){if(null==setting.section||null==this.currentSection)return!0;var currDepth=ResourcesProviderBase.sectionDepthMap[this.currentSection.text];if("mode"===setting.name){if(null==this.currentWidget)return!0;if("chart"===this.currentWidget)return"column-stack"===setting.value?currDepth<=ResourcesProviderBase.sectionDepthMap.widget:currDepth<=ResourcesProviderBase.sectionDepthMap.series}if(Array.isArray(setting.section))return setting.section.some(function(s){return currDepth<=ResourcesProviderBase.sectionDepthMap[s]});var reqDepth=ResourcesProviderBase.sectionDepthMap[setting.section];return currDepth<=reqDepth},Validator.prototype.handleRegularSetting=function(){var line=this.config.getCurrentLine(),setting=this.getSettingCheck();if(void 0!==setting){if(this.addSettingValue(setting),setting.deprecated&&this.result.push(Util.createDiagnostic(setting.textRange,setting.deprecated,vscodeLanguageserverTypes.DiagnosticSeverity.Warning)),this.isAllowedInSection(setting)||this.result.push(Util.createDiagnostic(setting.textRange,illegalSetting(setting.displayName),vscodeLanguageserverTypes.DiagnosticSeverity.Error)),"type"===setting.name){this.currentWidget=this.match[3];var reqs=ResourcesProviderBase.widgetRequirementsByType.get(this.currentWidget);reqs&&reqs.sections&&this.sectionStack.setSectionRequirements("widget",reqs.sections)}setting.multiLine?(this.currentSettings.push(setting),this.sectionStack.insertCurrentSetting(setting)):this.checkRepetition(setting),this.currentSection&&["placeholders","properties","property"].includes(this.currentSection.text)||(this.typeCheck(setting),this.checkExcludes(setting),"alias"===setting.name&&(this.match=/(^\s*alias\s*=\s*)(\S+)\s*$/m.exec(line),this.addToStringArray(this.aliases)),this.findDeAliases())}},Validator.prototype.checkSettingsWhitespaces=function(){var line=this.config.getCurrentLine(),match=/(^\s*)((\w+\s+)+\w+)\s*=\s*(.+?)\s*$/.exec(line);if(null!=match&&match[2]){var settingName=match[2];if(settingName&&!this.foundKeyword&&/^\w+(\s.*\w)+$/.test(settingName)){var start=line.indexOf(settingName),range=this.createRange(start,settingName.length);"tags"===this.currentSection.text?/^["].+["]$/.test(settingName)||this.result.push(Util.createDiagnostic(range,"The tag name "+settingName+" contains whitespaces. Wrap it in double quotes.",vscodeLanguageserverTypes.DiagnosticSeverity.Warning)):"properties"!==this.currentSection.text&&this.result.push(Util.createDiagnostic(range,function(found){return'The setting "'+found+'" contains whitespaces.\nReplace spaces with hyphens.'}(settingName),vscodeLanguageserverTypes.DiagnosticSeverity.Warning))}}},Validator.prototype.setLastCondition=function(){this.lastCondition=""+this.config.currentLineNumber+this.config.getCurrentLine()},Validator.prototype.spellingCheck=function(){if(null!=this.match){var indent=this.match[1].length,word=this.match[2],range=this.createRange(indent,word.length);"tag"===word&&this.result.push(Util.createDiagnostic(range,'Replace [tag] sections with [tags].\nEnclose the tag name in double quotes in case it contains special characters.\n\n[tag]\n  name = k\n  value = v\n[tag]\n  name = my column\n  value = my value\n\n[tags]\n  k = v\n  "my column" = my value\n',vscodeLanguageserverTypes.DiagnosticSeverity.Warning))}},Validator.prototype.switchKeyword=function(){if(void 0===this.foundKeyword)throw new Error("We're trying to handle a keyword, but foundKeyword is undefined");var line=this.config.getCurrentLine();switch(this.foundKeyword.text){case"endfor":this.handleEndFor();case"endif":this.lastEndIf=this.config.currentLineNumber;case"endvar":case"endcsv":case"endlist":case"endsql":case"endscript":var expectedEnd=this.foundKeyword.text.substring("end".length);this.checkEnd(expectedEnd);break;case"else":case"elseif":this.handleElse();break;case"csv":this.handleCsv();break;case"var":var openBrackets=line.match(/((\s*[\[\{\(]\s*)+)/g),closeBrackets=line.match(/((\s*[\]\}\)]\s*)+)/g);openBrackets&&(closeBrackets&&openBrackets.map(function(s){return s.trim()}).join("").length!==closeBrackets.map(function(s){return s.trim()}).join("").length||null===closeBrackets)&&this.keywordsStack.push(this.foundKeyword),this.match=/(var\s*)(\w+)\s*=/.exec(line),this.addToStringMap(this.variables,"varNames");break;case"list":this.handleList();break;case"for":this.handleFor();break;case"if":this.keywordHandler.handleIf(line,this.foundKeyword),this.setLastCondition();break;case"script":this.keywordHandler.handleScript(line,this.foundKeyword);break;case"sql":this.keywordHandler.handleSql(line,this.foundKeyword);break;case"import":break;default:throw new Error(this.foundKeyword.text+" is not handled")}},Validator.prototype.typeCheck=function(setting){if(null!=this.match){var range=this.createRange(this.match[1].length,this.match[2].length),diagnostic=setting.checkType(range);null!=diagnostic&&this.result.push(diagnostic)}},Validator.prototype.validateCsv=function(){var line=this.config.getCurrentLine(),columns=Util.countCsvColumns(line);columns===this.csvColumns||/^[ \t]*$/m.test(line)||this.result.push(Util.createDiagnostic(this.createRange(0,line.length),"Expected "+this.csvColumns+" columns, but found "+columns))},Validator.prototype.validateFor=function(){var line=this.config.getCurrentLine(),atRegexp=/@{.+?}/g;for(this.match=atRegexp.exec(line);null!==this.match;){var substr=this.match[0],startPosition=this.match.index,varRegexp=/[a-zA-Z_]\w*(?!\w*["\('])/g;for(this.match=varRegexp.exec(substr);null!==this.match;)if("."!==substr.charAt(this.match.index-1)){var variable=this.match[0];if(!Util.isInMap(variable,this.variables)){var position=startPosition+this.match.index,message=unknownToken(variable);this.result.push(Util.createDiagnostic(this.createRange(position,variable.length),message))}this.match=varRegexp.exec(substr)}else this.match=varRegexp.exec(substr);this.match=atRegexp.exec(line)}},Validator.prototype.getSetting=function(name){var start=this.config.getCurrentLine().indexOf(name),range=start>-1?this.createRange(start,name.length):void 0;return LanguageService.getResourcesProvider().getSetting(name,range)},Validator.prototype.checkUrlPlaceholders=function(){var phs=this.getUrlPlaceholders();phs.length>0&&this.currentSection&&this.currentSection.text.match(/widget/i)&&this.sectionStack.requireSections("widget","placeholders");var placeholderRange=this.sectionStack.getSectionRange("placeholders");if(placeholderRange){var phSectionSettings_1=this.sectionStack.getSectionSettings("placeholders",!1),missingPhs=phs.filter(function(key){var cleared=Setting.clearValue(key);return null==phSectionSettings_1.find(function(s){return s.name===cleared})});missingPhs.length>0&&this.result.push(Util.createDiagnostic(placeholderRange.range,"Missing placeholders: "+missingPhs.join(", ")+".",vscodeLanguageserverTypes.DiagnosticSeverity.Error));var unnecessaryPhs=phSectionSettings_1.filter(function(s){return!phs.includes(s.name)}).map(function(s){return s.name});unnecessaryPhs.length>0&&this.result.push(Util.createDiagnostic(placeholderRange.range,"Unnecessary placeholders: "+unnecessaryPhs.join(", ")+".",vscodeLanguageserverTypes.DiagnosticSeverity.Warning))}},Validator.prototype.getUrlPlaceholders=function(){var e_11,_a,result=new Set;try{for(var placeholderContainingSettings_1=__values(placeholderContainingSettings),placeholderContainingSettings_1_1=placeholderContainingSettings_1.next();!placeholderContainingSettings_1_1.done;placeholderContainingSettings_1_1=placeholderContainingSettings_1.next()){var setting=placeholderContainingSettings_1_1.value,currentSetting=this.sectionStack.getCurrentSetting(setting);if(currentSetting)for(var regexp=/{(.+?)}/g,match=regexp.exec(currentSetting.value);null!==match;){var cleared=Setting.clearSetting(match[1]);result.add(cleared),match=regexp.exec(currentSetting.value)}}}catch(e_11_1){e_11={error:e_11_1}}finally{try{placeholderContainingSettings_1_1&&!placeholderContainingSettings_1_1.done&&(_a=placeholderContainingSettings_1.return)&&_a.call(placeholderContainingSettings_1)}finally{if(e_11)throw e_11.error}}return __spread(result)},Validator.prototype.createRange=function(start,length){return Util.createRange(start,length,this.config.currentLineNumber)},Validator}();exports.CompletionProvider=CompletionProvider,exports.DefaultSetting=DefaultSetting,exports.Formatter=Formatter,exports.LanguageService=LanguageService,exports.ResourcesProviderBase=ResourcesProviderBase,exports.Setting=Setting,exports.Util=Util,exports.Validator=Validator,Object.defineProperty(exports,"__esModule",{value:!0})});